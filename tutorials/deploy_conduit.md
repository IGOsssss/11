<md-hidden>
üõë –î–∞–Ω–Ω—ã–π —Ç—É—Ç–æ—Ä–∏–∞–ª –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ GitHub üî¥ –Ω–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ! –≠—Ç–æ –ª–∏—à—å –∏—Å—Ö–æ–¥–Ω–∏–∫.<br>
–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è https://www.epic1h.com/deploy_conduit
</md-hidden>

# –¢—É—Ç–æ—Ä–∏–∞–ª: –¥–µ–ø–ª–æ–∏–º –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Å–≤–æ–µ–º —Å–µ—Ä–≤–µ—Ä–µ

–ü–æ–¥–æ–π–¥–µ—Ç —Ç–µ–º, –∫—Ç–æ —Ö–æ—á–µ—Ç –Ω–∞—É—á–∏—Ç—Å—è –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—è Docker –Ω–∞ —Å–≤–æ–µ–º —Å–µ—Ä–≤–µ—Ä–µ.

# üëç –ß—Ç–æ —Å–¥–µ–ª–∞–µ–º

* –°–æ–±–µ—Ä–µ–º –∏ –∑–∞–ø—É—Å—Ç–∏–º –ª–æ–∫–∞–ª—å–Ω–æ –ø—Ä–æ–µ–∫—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –≤–µ–¥–µ–Ω–∏—è –±–ª–æ–≥–æ–≤ –Ω–∞ Docker Swarm.
* –ù–∞—É—á–∏–º—Å—è –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—Ä–∞–∑ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ Docker Hub —Å –Ω—É–∂–Ω—ã–º —Ç–µ–≥–æ–º.
* –ù–∞—Å—Ç—Ä–æ–∏–º —Å–≤–æ–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ —á–µ—Ä–µ–∑ SSH.
* –†–∞–∑–≤–µ—Ä–Ω–µ–º –ø—Ä–æ–µ–∫—Ç –Ω–∞ –≤–Ω–µ—à–Ω–µ–º IP –∞–¥—Ä–µ—Å–µ –≤ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç.

# üî¢ –®–∞–≥–∏

## +1. –§–æ—Ä–∫–∞–µ–º Conduit

**A.** –ï—Å–ª–∏ —Ç—ã –ø—Ä–æ—Ö–æ–¥–∏–ª —Ç—É—Ç–æ—Ä–∏–∞–ª—ã:

* [–°–æ–±–∏—Ä–∞–µ–º Conduit –ª–æ–∫–∞–ª—å–Ω–æ](https://www.epic1h.com/build_conduit)
* [–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ CI/CD](https://www.epic1h.com/cypress_cicd)

- [x] –û—Ç–∫—Ä–æ–π –º–∞–º–∞ –ø—Ä–æ–µ–∫—Ç –≤ VS Code.

**B.** –ï—Å–ª–∏ –Ω–µ—Ç:

- [x] –°–¥–µ–ª–∞–π —Ñ–æ—Ä–∫ —Ä–µ–ø–æ–∑–∏—Ç–∞—Ä–∏—è [TonyMckes/conduit-realworld-example-app](https://github.com/TonyMckes/conduit-realworld-example-app)
- [x] –ö–ª–æ–Ω–∏—Ä—É–π –ø—Ä–æ–µ–∫—Ç –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä.
- [x] –û—Ç–∫—Ä–æ–π –ø—Ä–æ–µ–∫—Ç –≤ VS Code.

## +2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ Docker Hub

- [x] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –Ω–∞ https://hub.docker.com/
- [x] –ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª:

```bash
docker login --username {qwerty}
```

‚ùó `{qwerty}` ‚Äî —Ç–≤–æ–π –ª–æ–≥–∏–Ω –Ω–∞ Docker Hub.

## +3. –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç –ª–æ–∫–∞–ª—å–Ω–æ

### 3.1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –±–µ–∫–µ–Ω–¥–∞

- [x] –ü–æ–ø—Ä–∞–≤—å —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `backend/config/config.js`

```diff
    production: {
      username: process.env.PG_USER,
-     password: process.env.PG_PASSWORD,
+     password: require("fs").readFileSync(process.env.PG_PASSWORD_FILE, "utf8"),
      database: process.env.PG_DATABASE,
      host: process.env.PG_HOST,
      dialect: "postgres",
-     dialectOptions: {
-       ssl: {
-         require: true,
-         rejectUnauthorized: false,
-       },
      },
    },
```

### 3.2. –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑

- [x] –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `Dockerfile`

```text
FROM node:16
ARG node_env
ENV NODE_ENV=$node_env \
    PORT=80
WORKDIR /app
COPY ./ ./
RUN npm ci --only=production
RUN npm -w frontend run build
EXPOSE 80
CMD npm run start -w backend

```

- [x] –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `.dockerignore`

```text
node_modules
```

- [x] –°–æ–±–µ—Ä–∏ –æ–±—Ä–∞–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:

```bash
docker build --build-arg node_evn=production --tag {qwerty}/conduit:1.0.0 .
```

‚ùó `{qwerty}` ‚Äî —Ç–≤–æ–π –ª–æ–≥–∏–Ω –Ω–∞ Docker Hub.

- [x] –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –æ–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω –∏ –∑–∞—Ç–µ–≥–∏—Ä–æ–≤–∞–Ω —Å –≤–µ—Ä—Å–∏–µ–π `1.0.0`

```bash
docker images
```

## +4. Docker –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è

- [x] –ê–∫—Ç–∏–≤–∏—Ä—É–π –≤ Docker —Ä–µ–∂–∏–º —Ä–æ—è:

```bash
docker swarm init
```

- [x] –°–æ–∑–¥–∞–π —Å–µ–∫—Ä–µ—Ç—ã –ø–æ—à–∞–≥–æ–≤–æ:

```bash
echo "xxxYYY" | docker secret create db_root_password -
echo "yyyZZZ" | docker secret create db_password -
```

- [x] –ü—Ä–æ–≤–µ—Ä—å —Å–µ–∫—Ä–µ—Ç—ã –ø–æ—à–∞–≥–æ–≤–æ:

```bash
docker secret ls
docker secret inspect db_root_password
docker secret inspect db_password
```

- [x] –°–æ–∑–¥–∞–π –≤–æ–ª—å—é–º—ã:

```bash
docker volume create pg_data
```

- [x] –ü—Ä–æ–≤–µ—Ä—å –≤–æ–ª—å—é–º—ã:

```bash
docker volume ls
docker volume inspect pg_data
```

- [x] –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `deploy.yml`

```yaml
version: "3.9"

secrets:
  db_root_password:
    external: true
  db_password:
    external: true

volumes:
  pg_data:
    external: true

services:
  postgres:
    image: postgres:15.2-bullseye
    secrets:
      - db_root_password
    environment:
      POSTGRES_PASSWORD_FILE: /run/secrets/db_root_password
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      retries: 15
      start_period: 2s
      timeout: 10s

  conduit:
    image: {qwerty}/conduit:${VERSION}
    links:
      - "postgres:postgres"
    ports:
      - 80:80
    depends_on:
      - postgres
    secrets:
      - db_password
    environment:
      NODE_ENV: production
      JWT_KEY: secret
      PG_HOST: postgres
      PG_USER: conduit
      PG_PASSWORD_FILE: /run/secrets/db_password
      PG_DATABASE: conduit
    healthcheck:
      test: curl --fail http://localhost || exit 1
      interval: 10s
      retries: 15
      start_period: 2s
      timeout: 10s
```

- [x] ‚ùó –ó–∞–º–µ–Ω–∏ –≤ —Ñ–∞–π–ª–µ `{qwerty}` –Ω–∞ —Ç–≤–æ–π –ª–æ–≥–∏–Ω –Ω–∞ Docker Hub.
- [x] –°–¥–µ–ª–∞–π –¥–µ–ø–ª–æ–π —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ —Å—Ç–µ–∫–µ:

```bash
VERSION=1.0.0 docker stack deploy --compose-file deploy.yml app_blogs
```

- [x] –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ —Å—Ç–µ–∫ –ø–æ—è–≤–∏–ª—Å—è:

```bash
docker stack ls
```

- [x] –ü—Ä–æ–≤–µ—Ä—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ —Å—Ç–µ–∫–µ:

```bash
docker stack services app_blogs
```

- [x] –ü—Ä–æ–≤–µ—Ä—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ª–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞ Postgres:

```bash
docker service ps app_blogs_postgres
docker service logs app_blogs_postgres
```

- [x] –ü—Ä–æ–≤–µ—Ä—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ª–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞ Conduit:

```bash
docker service ps app_blogs_conduit
docker service logs app_blogs_conduit
```

- [x] –û—Ç–∫—Ä–æ–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ http://localhost

## +5. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

- [x] –ù–∞–π–¥–∏ ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è Postgres:

```bash
docker ps --format '{{.Names}}'
```

```
app_postgres.1.xyz
```

- [x] –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ –∫–æ–Ω—Å–æ–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å Postgres:

```bash
docker exec -it app_blogs_postgres.1.{xyz} /bin/bash
```

‚ùó `{xyz}` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä.

- [x] –ü–µ—Ä–µ–∫–ª—é—á–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```bash
su postgres
```

- [x] –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ –°–£–ë–î —á–µ—Ä–µ–∑ –ø—Ä–æ–≥—Ä–∞–º–º—É –∫–ª–∏–µ–Ω—Ç:

```bash
psql
```

- [x] –°–æ–∑–¥–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `conduit`

```bash
create user conduit with password 'yyyZZZ';
```

- [x] –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—è–≤–∏–ª—Å—è:

```bash
\du
```

- [x] –°–æ–∑–¥–∞–π –±–∞–∑—É —Å –∏–º–µ–Ω–µ–º `conduit`

```bash
create database conduit;
```

- [x] –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –±–∞–∑–∞ —Å–æ–∑–¥–∞–Ω–∞:

```bash
\l
```

- [x] –ù–∞–∑–Ω–∞—á—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –±–∞–∑—ã –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```bash
alter database conduit owner to conduit;
```

- [x] –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü –Ω–∞–∑–Ω–∞—á–µ–Ω:

```bash
\l
```

- [x] –û—Ç–∫–ª—é—á–∏—Å—å –æ—Ç –°–£–ë–î:

```bash
\q
```

- [x] –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```bash
psql -h localhost -d conduit -U conduit -W
```

‚ùó –í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å `yyyZZZ`

- [x] –í—ã–π–¥–∏ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:

```bash
exit
exit
```

## +6. –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–∑—ã

- [x] –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å Conduit:

```bash
docker service update app_blogs_conduit --force
```

- [x] –ù–∞–π–¥–∏ ID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è Conduit:

```bash
docker ps --format '{{.Names}}'
```

- [x] –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ –∫–æ–Ω—Å–æ–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å Conduit:

```bash
docker exec -it app_blogs_conduit.1.{xyz} /bin/bash
```

‚ùó `{xyz}` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä. 

- [x] –ó–∞–ø–æ–ª–Ω–∏ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:

```bash
npx -w backend sequelize-cli db:seed:all
```

- [x] –û—Ç–∫—Ä–æ–π http://localhost/

## +7. –ü—É–±–ª–∏–∫–∞—Ü–∏—è Docker –æ–±—Ä–∞–∑–∞

- [x] –°–æ–±–µ—Ä–∏ –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑ `1.0.0-amd64` –ø–æ–¥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å–µ—Ä–≤–µ—Ä–∞:

```bash
docker build --platform linux/amd64 -t {qwerty}/conduit:1.0.0-amd64 .
```

- [x] –ü—Ä–æ–≤–µ—Ä—å —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞–∑–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º Docker —Ä–µ–ø–æ–∑–∏—Ç–∞—Ä–∏–∏:

```bash
docker images
```

- [x] –ó–∞–ø—É—à—å –Ω—É–∂–Ω—ã–π –æ–±—Ä–∞–∑:

```bash
docker push {qwerty}/conduit:1.0.0-amd64
```

‚ùó `{qwerty}` ‚Äî —Ç–≤–æ–π –ª–æ–≥–∏–Ω –Ω–∞ Docker Hub.

- [x] –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –æ–±—Ä–∞–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω:

https://hub.docker.com/repository/docker/{qwerty}/conduit/general

## +8. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞

- [x] –ó–∞–∫–∞–∂–∏ —Å–µ—Ä–≤–µ—Ä 10 GB SSD.
- [x] –ü–æ–¥–≥–æ—Ç–æ–≤—å —Å–µ—Ä–≤–µ—Ä:

```bash
apt-get update
apt-get -qq install docker.io
```

## +9. –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞

- [x] –ê–∫—Ç–∏–≤–∏—Ä—É–π –≤ Docker —Ä–µ–∂–∏–º —Ä–æ—è:

```bash
docker swarm init
```

- [x] –°–æ–∑–¥–∞–π —Å–µ–∫—Ä–µ—Ç—ã –ø–æ—à–∞–≥–æ–≤–æ:

```bash
echo "xxxYYY" | docker secret create db_root_password -
echo "yyyZZZ" | docker secret create db_password -
```

- [x] –ü—Ä–æ–≤–µ—Ä—å —Å–µ–∫—Ä–µ—Ç—ã –ø–æ—à–∞–≥–æ–≤–æ:

```bash
docker secret ls
docker secret inspect db_root_password
docker secret inspect db_password
```

- [x] –°–æ–∑–¥–∞–π –≤–æ–ª—å—é–º—ã:

```bash
docker volume create pg_data
```

- [x] –ü—Ä–æ–≤–µ—Ä—å –≤–æ–ª—å—é–º—ã:

```bash
docker volume ls
docker volume inspect pg_data
```

- [x] –ó–∞–≥—Ä—É–∑–∏ `compose` —Ñ–∞–π–ª:

```bash
apt-get -qq install vim
vi deploy.yml
```

- [x] –ó–∞–ø—É–ª—å —Å Docker Hub –Ω—É–∂–Ω—ã–π –æ–±—Ä–∞–∑:

```bash
docker pull {qwerty}/conduit:1.0.0-amd64
```

- [x] –í—ã–ø–æ–ª–Ω–∏ –¥–µ–ø–ª–æ–π —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ —Å—Ç–µ–∫–µ `app_blogs`

```bash
VERSION=1.0.0-amd64 docker stack deploy --compose-file deploy.yml app_blogs
```

- [x] –°–æ–∑–¥–∞–π –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```bash
docker exec -it app_blogs_postgres.1.{xyz} /bin/bash
su postgres
psql
create user conduit with password 'yyyZZZ';
\du
create database conduit;
\l
alter database conduit owner to conduit;
\l
\q
exit
exit
```

- [x] –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å—ã:

```bash
docker service update app_blogs_conduit --force
npx -w backend sequelize-cli db:seed:all
```